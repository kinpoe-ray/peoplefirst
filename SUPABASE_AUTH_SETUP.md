# Supabase è®¤è¯é…ç½®è¯´æ˜

æœ¬é¡¹ç›®å·²å®Œæ•´é…ç½®äº†åŸºäºSupabaseçš„å¤šè§’è‰²è®¤è¯ç³»ç»Ÿï¼Œæ”¯æŒå­¦ç”Ÿã€è€å¸ˆã€æ ¡å‹ä¸‰ç§ç”¨æˆ·è§’è‰²ã€‚

## ğŸ“ æ–‡ä»¶ç»“æ„

```
src/
â”œâ”€â”€ lib/
â”‚   â””â”€â”€ supabase.ts              # Supabaseå®¢æˆ·ç«¯é…ç½®å’Œç±»å‹å®šä¹‰
â”œâ”€â”€ contexts/
â”‚   â””â”€â”€ AuthContext.tsx          # è®¤è¯ä¸Šä¸‹æ–‡æä¾›è€…
â”œâ”€â”€ hooks/
â”‚   â”œâ”€â”€ use-mobile.tsx           # ç§»åŠ¨ç«¯æ£€æµ‹Hook
â”‚   â””â”€â”€ useAuth.ts               # è®¤è¯ç›¸å…³Hook
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ Layout.tsx               # é¡µé¢å¸ƒå±€ç»„ä»¶
â”‚   â”œâ”€â”€ AuthNavigation.tsx       # è®¤è¯å¯¼èˆªæ 
â”‚   â””â”€â”€ AuthStatus.tsx           # è®¤è¯çŠ¶æ€æ˜¾ç¤ºç»„ä»¶
â””â”€â”€ pages/
    â”œâ”€â”€ Login.tsx                # ç™»å½•é¡µé¢
    â””â”€â”€ Register.tsx             # æ³¨å†Œé¡µé¢

.env                             # ç¯å¢ƒå˜é‡é…ç½®
supabase/migrations/
â”œâ”€â”€ 1762001504_enable_rls_and_policies.sql
â””â”€â”€ 1762002000_enhanced_rls_policies_multi_role.sql
```

## ğŸ”§ é…ç½®è¯¦æƒ…

### 1. ç¯å¢ƒå˜é‡é…ç½® (.env)

```env
VITE_SUPABASE_URL=https://qpgefcjcuhcqojiawpit.supabase.co
VITE_SUPABASE_ANON_KEY=your_anon_key_here
VITE_APP_ENV=development
VITE_APP_NAME=Evolv Platform
```

### 2. Supabaseå®¢æˆ·ç«¯é…ç½® (lib/supabase.ts)

- ä½¿ç”¨ç¯å¢ƒå˜é‡åˆå§‹åŒ–Supabaseå®¢æˆ·ç«¯
- å®šä¹‰äº†å®Œæ•´çš„TypeScriptç±»å‹ç³»ç»Ÿ
- åŒ…å«è§’è‰²æƒé™æ£€æŸ¥å·¥å…·å‡½æ•°
- æä¾›äº†æ•°æ®åº“æ“ä½œçš„è¾…åŠ©å‡½æ•°

### 3. è®¤è¯ä¸Šä¸‹æ–‡ (contexts/AuthContext.tsx)

æä¾›å®Œæ•´çš„è®¤è¯åŠŸèƒ½ï¼š
- ç”¨æˆ·çŠ¶æ€ç®¡ç†
- ç™»å½•/æ³¨å†Œ/ç™»å‡º
- è‡ªåŠ¨ä¼šè¯æ£€æµ‹
- Profileè‡ªåŠ¨åˆ›å»º

### 4. è®¤è¯Hook (hooks/useAuth.ts)

æä¾›ä¾¿æ·çš„è®¤è¯Hookæ¥å£ï¼š
- `useAuth()` - åŸºæœ¬è®¤è¯Hook
- `withAuth()` - é«˜é˜¶ç»„ä»¶ä¿æŠ¤è·¯ç”±
- `usePermissions()` - æƒé™æ£€æŸ¥Hook
- `useRoleCheck()` - è§’è‰²æ£€æŸ¥Hook

## ğŸ‘¥ å¤šè§’è‰²ç³»ç»Ÿ

### ç”¨æˆ·è§’è‰²
- **student**: å­¦ç”Ÿï¼Œå¯ä»¥å­¦ä¹ æŠ€èƒ½ã€å‚ä¸ç¤¾äº¤
- **teacher**: è€å¸ˆï¼Œå¯ä»¥åˆ›å»ºè¯¾ç¨‹ã€é—®é¢˜ï¼Œç®¡ç†å­¦ç”Ÿ
- **alumni**: æ ¡å‹ï¼Œå¯ä»¥åˆ›å»ºè¯¾ç¨‹ã€å‚ä¸ç¤¾äº¤

### æƒé™çŸ©é˜µ

| åŠŸèƒ½ | å­¦ç”Ÿ | è€å¸ˆ | æ ¡å‹ |
|------|------|------|------|
| æŸ¥çœ‹å…¬å¼€èµ„æ–™ | âœ… | âœ… | âœ… |
| ç¼–è¾‘ä¸ªäººèµ„æ–™ | âœ… | âœ… | âœ… |
| åˆ›å»ºæŠ€èƒ½è®°å½• | âœ… | âœ… | âœ… |
| å‚ä¸ç¤¾äº¤äº’åŠ¨ | âœ… | âœ… | âœ… |
| åˆ›å»ºè¯¾ç¨‹ | âŒ | âœ… | âœ… |
| åˆ›å»ºé—®é¢˜ | âŒ | âœ… | âŒ |
| æŸ¥çœ‹å­¦ç”Ÿè¯„ä¼° | âŒ | âœ… | âŒ |

## ğŸ›¡ï¸ RLS (è¡Œçº§å®‰å…¨) ç­–ç•¥

é¡¹ç›®å®ç°äº†å®Œæ•´çš„è¡Œçº§å®‰å…¨ç­–ç•¥ï¼Œç¡®ä¿ï¼š

1. **æ•°æ®éš”ç¦»**ï¼šç”¨æˆ·åªèƒ½è®¿é—®è‡ªå·±çš„ç§æœ‰æ•°æ®
2. **è§’è‰²æƒé™**ï¼šä¸åŒè§’è‰²æœ‰ä¸åŒçš„æ•°æ®è®¿é—®æƒé™
3. **å…¬å¼€æ•°æ®**ï¼šæŸäº›æ•°æ®ï¼ˆå¦‚æŠ€èƒ½ã€å¾½ç« ï¼‰å¯¹æ‰€æœ‰è®¤è¯ç”¨æˆ·å¯è§
4. **æ•™å­¦ç®¡ç†**ï¼šè€å¸ˆå¯ä»¥æŸ¥çœ‹å’Œç®¡ç†å­¦ç”Ÿçš„ç›¸å…³æ•°æ®

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### 1. åŒ…è£…åº”ç”¨
```tsx
// App.tsx
import { AuthProvider } from './contexts/AuthContext';

function App() {
  return (
    <AuthProvider>
      {/* ä½ çš„åº”ç”¨ç»„ä»¶ */}
    </AuthProvider>
  );
}
```

### 2. ä½¿ç”¨è®¤è¯Hook
```tsx
import { useAuth } from './hooks/useAuth';

function MyComponent() {
  const { user, profile, isTeacher, signOut } = useAuth();
  
  if (!user) {
    return <div>è¯·å…ˆç™»å½•</div>;
  }
  
  return (
    <div>
      <h1>æ¬¢è¿ï¼Œ{profile?.full_name}</h1>
      {isTeacher && <TeacherPanel />}
    </div>
  );
}
```

### 3. è·¯ç”±ä¿æŠ¤
```tsx
import { withAuth } from './hooks/useAuth';

const ProtectedComponent = withAuth(YourComponent);
```

### 4. æ˜¾ç¤ºè®¤è¯çŠ¶æ€
```tsx
import { AuthStatus, RoleBadge } from './components/AuthStatus';

function UserInfo() {
  return (
    <div>
      <AuthStatus showRole showDetails />
      <RoleBadge />
    </div>
  );
}
```

## ğŸ”„ æ•°æ®åº“è‡ªåŠ¨è§¦å‘å™¨

ç³»ç»ŸåŒ…å«è‡ªåŠ¨è§¦å‘å™¨ï¼š
- æ–°ç”¨æˆ·æ³¨å†Œæ—¶è‡ªåŠ¨åˆ›å»ºProfileè®°å½•
- ç”¨æˆ·åˆ é™¤æ—¶çº§è”åˆ é™¤ç›¸å…³æ•°æ®

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **ç¯å¢ƒå˜é‡**ï¼šç¡®ä¿åœ¨ç”Ÿäº§ç¯å¢ƒä¸­æ­£ç¡®è®¾ç½®ç¯å¢ƒå˜é‡
2. **RLSç­–ç•¥**ï¼šä¿®æ”¹ç­–ç•¥åéœ€è¦é‡æ–°éƒ¨ç½²åˆ°Supabase
3. **ç±»å‹å®‰å…¨**ï¼šæ‰€æœ‰æ•°æ®åº“æ“ä½œéƒ½æœ‰TypeScriptç±»å‹ä¿æŠ¤
4. **ä¼šè¯ç®¡ç†**ï¼šSupabaseè‡ªåŠ¨å¤„ç†ä»¤ç‰Œåˆ·æ–°å’Œä¼šè¯ç®¡ç†

## ğŸ”§ å¼€å‘å’Œéƒ¨ç½²

1. **æœ¬åœ°å¼€å‘**ï¼š
   ```bash
   pnpm install
   pnpm dev
   ```

2. **æ„å»ºéƒ¨ç½²**ï¼š
   ```bash
   pnpm build
   ```

3. **æ•°æ®åº“è¿ç§»**ï¼š
   - è¿ç§»æ–‡ä»¶å·²åŒ…å«åœ¨supabase/migrations/ç›®å½•ä¸­
   - éœ€è¦æ‰‹åŠ¨åº”ç”¨åˆ°Supabaseé¡¹ç›®

## ğŸ†˜ æ•…éšœæ’é™¤

1. **ç™»å½•å¤±è´¥**ï¼šæ£€æŸ¥Supabaseé…ç½®å’Œç½‘ç»œè¿æ¥
2. **æƒé™é”™è¯¯**ï¼šæ£€æŸ¥RLSç­–ç•¥é…ç½®
3. **ç±»å‹é”™è¯¯**ï¼šç¡®ä¿å®‰è£…äº†æ­£ç¡®çš„TypeScriptç±»å‹å®šä¹‰
4. **ç¯å¢ƒå˜é‡**ï¼šç¡®ä¿æ‰€æœ‰å¿…éœ€çš„ç¯å¢ƒå˜é‡éƒ½å·²è®¾ç½®

---

è¿™ä¸ªé…ç½®æä¾›äº†ä¸€ä¸ªå®Œæ•´ã€å®‰å…¨ã€æ˜“äºæ‰©å±•çš„å¤šè§’è‰²è®¤è¯ç³»ç»Ÿã€‚